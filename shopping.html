<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Shopping Cart</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script
      type="text/javascript"
      src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"
    ></script>
    <script type="text/javascript">
      (function () {
        emailjs.init({
          publicKey: "AGv2jrM30EV7lGPWv",
        });
        console.log("EmailJS initialized:", emailjs);
      })();
    </script>

    <style>
      .product-img {
        width: 80px;
        height: 80px;
        object-fit: cover;
        border-radius: 8px;
      }
      .logo img {
        width: 80px;
      }
      .empty-message {
        text-align: center;
        margin-top: 50px;
      }
      .quantity-controls {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .quantity-controls button {
        width: 30px;
        height: 30px;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 0;
        font-size: 14px;
      }
      /* Responsive Styles */
      @media (max-width: 768px) {
        .container {
          padding: 0 15px;
        }
        .table {
          font-size: 14px;
        }
        .product-img {
          width: 60px;
          height: 60px;
        }
        .d-flex {
          flex-direction: column;
          align-items: flex-start;
        }
        .d-flex.flex-wrap {
          flex-direction: row-reverse;
          align-items: center;
          gap: 15px;
        }
        .d-flex.align-items-center {
          align-items: flex-start;
        }
        .btn {
          margin-bottom: 10px;
        }
        .modal-dialog {
          max-width: 90%;
        }
      }
      @media (max-width: 576px) {
        .table thead {
          display: none;
        }
        .table tbody tr {
          display: block;
          margin-bottom: 15px;
        }
        .table tbody td {
          display: flex;
          justify-content: space-between;
          padding: 10px 0;
          border: none;
          border-bottom: 1px solid #ddd;
        }
        .table tbody td:last-child {
          border-bottom: none;
        }
        .table tbody td::before {
          content: attr(data-label);
          font-weight: bold;
          margin-right: 10px;
        }
        .btn {
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <!-- Logo -->
    <div class="logo text-center mt-3">
      <img src="images/img.jpg" alt="Logo" />
    </div>

    <div class="container mt-5">
      <h2 class="mb-4 text-center">üõí Your Shopping Cart</h2>
      <div id="cart-container"></div>

      <div
        class="mt-4 d-flex justify-content-between align-items-center flex-wrap"
      >
        <h4>Total: <span id="total-price">&#8358;0</span></h4>
        <div class="d-flex flex-wrap">
          <a href="product.html" class="btn btn-outline-primary me-2 mb-2"
            >Continue Shopping</a
          >
          <button class="btn btn-success mb-2" id="checkout-btn">
            Proceed to Checkout
          </button>
        </div>
      </div>
    </div>

    <!-- Account Info Modal -->
    <div
      class="modal fade"
      id="accountInfoModal"
      tabindex="-1"
      aria-labelledby="accountInfoModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
          <form id="accountInfoForm">
            <div class="modal-header">
              <h5 class="modal-title" id="accountInfoModalLabel">
                Enter Your Account Information
              </h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="Close"
              ></button>
            </div>
            <div class="modal-body row g-3">
              <div class="col-md-6">
                <label for="name" class="form-label">Full Name</label>
                <input type="text" class="form-control" id="name" required />
              </div>
              <div class="col-md-6">
                <label for="email" class="form-label">Email Address</label>
                <input type="email" class="form-control" id="email" required />
              </div>
              <div class="col-md-6">
                <label for="phone" class="form-label">Phone Number</label>
                <input type="tel" class="form-control" id="phone" required />
              </div>
              <div class="col-md-12">
                <label for="address" class="form-label">Shipping Address</label>
                <textarea
                  class="form-control"
                  id="address"
                  rows="2"
                  required
                ></textarea>
              </div>
            </div>
            <div class="modal-footer">
              <button type="submit" class="btn btn-success">
                Continue to Payment
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script>
      const cartContainer = document.getElementById("cart-container");
      const totalPriceElement = document.getElementById("total-price");
      // Removed clearCartBtn reference because Clear Cart button no longer exists
      const checkoutBtn = document.getElementById("checkout-btn");

      function loadCart() {
        let cart = JSON.parse(localStorage.getItem("cart")) || [];

        if (cart.length === 0) {
          cartContainer.innerHTML = `
            <div class="empty-message">
              <h5>Your cart is empty üò¢</h5>
            </div>`;
          totalPriceElement.textContent = "‚Ç¶0";
          checkoutBtn.style.display = "none";
          return;
        }

        checkoutBtn.style.display = "inline-block";

        let total = 0;
        let html = `
          <table class="table align-middle">
            <thead>
              <tr>
                <th>Product</th>
                <th>Price</th>
                <th>Quantity</th>
                <th>Subtotal</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
        `;

        cart.forEach((item, index) => {
          const subtotal = item.price * item.quantity;
          total += subtotal;

const imageSrc = `images/product${item.id}.jpg`;

          html += `
            <tr>
              <td data-label="Product">
                <div class="d-flex align-items-center">
                  <img src="${imageSrc}" alt="${item.name}" class="product-img me-3" />
                  <div>
                    <strong>${item.name}</strong>
                    <div>
                      <label for="size-${index}" class="form-label mb-0 small">Size:</label>
                      <select id="size-${index}" class="form-select form-select-sm" onchange="updateSize(${index}, this.value)">
                        <option value="Small" ${item.size === "Small" ? "selected" : ""}>Small</option>
                        <option value="Medium" ${item.size === "Medium" ? "selected" : ""}>Medium</option>
                        <option value="Large" ${item.size === "Large" ? "selected" : ""}>Large</option>
                      </select>
                    </div>
                  </div>
                </div>
              </td>
              <td data-label="Price">‚Ç¶${item.price.toLocaleString()}</td>
              <td data-label="Quantity">
                <div class="quantity-controls">
                  <button class="btn btn-sm btn-outline-secondary" onclick="updateQuantity(${index}, -1)">-</button>
                  <span>${item.quantity}</span>
                  <button class="btn btn-sm btn-outline-secondary" onclick="updateQuantity(${index}, 1)">+</button>
                </div>
              </td>
              <td data-label="Subtotal">‚Ç¶${subtotal.toLocaleString()}</td>
              <td data-label="Actions">
                <button class="btn btn-sm btn-outline-danger" onclick="removeItem(${index})">Remove</button>
              </td>
            </tr>
          `;
        });

        html += `</tbody></table>`;
        cartContainer.innerHTML = html;
        totalPriceElement.textContent = `‚Ç¶${total.toLocaleString()}`;
      }

      function updateQuantity(index, change) {
        let cart = JSON.parse(localStorage.getItem("cart")) || [];
        cart[index].quantity += change;

        if (cart[index].quantity <= 0) {
          cart.splice(index, 1);
        }

        localStorage.setItem("cart", JSON.stringify(cart));
        loadCart();
      }

      function updateSize(index, selectedSize) {
        let cart = JSON.parse(localStorage.getItem("cart")) || [];
        cart[index].size = selectedSize;
        localStorage.setItem("cart", JSON.stringify(cart));
      }

      function removeItem(index) {
        let cart = JSON.parse(localStorage.getItem("cart")) || [];
        cart.splice(index, 1);
        localStorage.setItem("cart", JSON.stringify(cart));
        loadCart();
      }

      checkoutBtn.addEventListener("click", () => {
        const accountModal = new bootstrap.Modal(
          document.getElementById("accountInfoModal")
        );
        accountModal.show();
      });

      document
        .getElementById("accountInfoForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();

          const userData = {
            name: document.getElementById("name").value.trim(),
            email: document.getElementById("email").value.trim(),
            phone: document.getElementById("phone").value.trim(),
            address: document.getElementById("address").value.trim(),
          };

          localStorage.setItem("accountInfo", JSON.stringify(userData));

          const totalAmount = parseFloat(
            document.getElementById("total-price").textContent.replace(/[‚Ç¶,]/g, "")
          );

          let handler = PaystackPop.setup({
            key: "pk_live_1d2f2a9c7b6f0b8b73719aad72ad48ba4a8b2001",
            email: userData.email,
            amount: totalAmount * 100,
            currency: "NGN",
            ref: "REF_" + Math.floor(Math.random() * 1000000000),
            metadata: {
              custom_fields: [
                {
                  display_name: userData.name,
                  variable_name: "address",
                  value: userData.address,
                },
              ],
            },
            callback: function (response) {
              console.log("Paystack payment successful. Ref:", response.reference);
              const cart = JSON.parse(localStorage.getItem("cart")) || [];
              const cartSummary = cart
                .map(
                  (item) =>
                    `${item.name} (x${item.quantity}, Size: ${item.size || "N/A"})`
                )
                .join(", ");

              emailjs
                .send("service_lgjo8zv", "template_q8jcuzc", {
                  name: userData.name,
                  email: userData.email,
                  phone: userData.phone,
                  address: userData.address,
                  cart_summary: cartSummary,
                  total: `‚Ç¶${totalAmount.toLocaleString()}`,
                  reference: response.reference,
                })
                .then(function (emailResponse) {
                  console.log(
                    "‚úÖ Email sent!",
                    emailResponse.status,
                    emailResponse.text
                  );
                })
                .catch(function (error) {
                  console.error("‚ùå EmailJS error:", error);
                });

              alert("Payment successful! Thank you for your order.");
              localStorage.removeItem("cart");
              loadCart();
              bootstrap.Modal.getInstance(
                document.getElementById("accountInfoModal")
              ).hide();
            },
            onClose: function () {
              alert("Payment cancelled.");
            },
          });

          handler.openIframe();
        });

      loadCart();
    </script>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      crossorigin="anonymous"
    ></script>
    <script src="https://js.paystack.co/v1/inline.js"></script>
  </body>
</html>
